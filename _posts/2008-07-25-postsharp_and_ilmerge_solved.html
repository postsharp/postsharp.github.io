---
layout: post 
comments: true
title: "PostSharp and ILMerge [Solved?]"
date: 2008-07-25 11:24:00 +02:00
categories: [General]
permalink: /post/postsharp-and-ilmerge-solved.html
author: "Gael Fraiteur"
---
<p>In my previous post I claimed that it was not possible, in general, to merge assemblies enhanced by PostSharp, because it would break the assembly references stored as strings in aspect serialization data.</p>


  <p>I did not realize that the <strong>BinaryFormatter</strong> provides a way to solve our problem. It is indeed possible to provide its own <strong>SerializationBinder</strong>, whose role is precisely to return the <strong>System.Type</strong> corresponding to an assembly name and a type name. We can provide a custom binder to redirect merged assemblies.</p>  <p>This is the feature I have added to build 1.0.10.411 available for download in the <a href="http://download.postsharp.org/builds">builds section</a>; I could still do it in 1.0 since it is a no-risk feature, breaking nothing existing (if you don't use it, nothing can go wrong).</p>  <p>I have added a new class <strong>PostSharp.Laos.LaosSerializationBinder</strong>. You can set the static property <strong>Current</strong> to your own implementation of <strong>SerializationBinder</strong>. If you don't set it, nothing is changed. The <strong>LaosSerializationBinder</strong> class it itself derived from <strong>SerializationBinder</strong> and implements the feature we need: assembly retargeting. So all you have to do is to create an instance of this class, set up retargeting policies, and assign it to <strong>LaosSerializationBinder.Current</strong>.</p>  <p>The following code sets up PostSharp Laos so that references to 'MergedPostSharpLib.dll' are retargeted to 'MergedPostSharp.exe' (supposing that the library has been merged into the executable):</p>  <p class="MsoNormal" style="margin-bottom: 0pt; line-height: normal; mso-layout-grid-align: none"><span style="font-size: 10pt; color: #2b91af; font-family: consolas; mso-bidi-font-family: " yes?="yes?" mso-no-proof:="mso-no-proof:" roman?;="roman?;" new="new" times="times">LaosSerializationBinder</span><span style="font-size: 10pt; font-family: consolas; mso-bidi-font-family: " yes?="yes?" mso-no-proof:="mso-no-proof:" roman?;="roman?;" new="new" times="times"> binder = <span style="color: blue">new</span> <span style="color: #2b91af">LaosSerializationBinder</span>();       <br></span><span style="font-size: 10pt; font-family: consolas; mso-bidi-font-family: " yes?="yes?" mso-no-proof:="mso-no-proof:" roman?;="roman?;" new="new" times="times">binder.Retarget(<span style="color: #a31515">&quot;MergedPostSharpLib&quot;</span>, <span style="color: #a31515">&quot;MergedPostSharp&quot;</span>);       <br></span><span style="font-size: 10pt; color: #2b91af; line-height: 115%; font-family: consolas; mso-bidi-font-family: " yes?="yes?" mso-no-proof:="mso-no-proof:" roman?;="roman?;" new="new" times="times">LaosSerializationBinder</span><span style="font-size: 10pt; line-height: 115%; font-family: consolas; mso-bidi-font-family: " yes?="yes?" mso-no-proof:="mso-no-proof:" roman?;="roman?;" new="new" times="times">.Current = binder;</span></p>  <p class="MsoNormal" style="margin-bottom: 0pt; line-height: normal; mso-layout-grid-align: none">The only thing you have to really take care about is to set up the binder before the first aspect is deserialized. Aspect deserialization is triggered from static constructors of enhanced classes, so you may need to initialize the weaver very soon, and eventually to refactor your &quot;Main(string args[])&quot; method.</p>  <p class="MsoNormal" style="margin-bottom: 0pt; line-height: normal; mso-layout-grid-align: none">Apart from that, it should work very well.</p>  <p class="MsoNormal" style="margin-bottom: 0pt; line-height: normal; mso-layout-grid-align: none">Happy PostSharping!</p>  <p class="MsoNormal" style="margin-bottom: 0pt; line-height: normal; mso-layout-grid-align: none">~Gael</p>
